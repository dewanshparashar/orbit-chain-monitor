name: Chain Uptime Monitor

on:
  workflow_dispatch:
  schedule:
  - cron: '20 * * * *' # Run every 20 minutes

jobs:
  run-monitoring:
    name: Chain Uptime Monitor
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Arbitrum Portal repository
        uses: actions/checkout@v4
        with:
          repository: OffchainLabs/arbitrum-portal
          path: arbitrum-portal
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22
          cache: 'yarn'
          cache-dependency-path: |
            arbitrum-portal/yarn.lock
            arbitrum-monitoring/yarn.lock

      - name: Cache Portal dependencies
        uses: actions/cache@v4
        with:
          path: arbitrum-portal/node_modules
          key: ${{ runner.os }}-portal-yarn-${{ hashFiles('arbitrum-portal/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-portal-yarn-
      - name: Install dependencies (Portal)
        run: cd arbitrum-portal && yarn install

      - name: Checkout Arbitrum Monitoring repository
        uses: actions/checkout@v4
        with:
          repository: OffchainLabs/arbitrum-monitoring
          ref: chain-uptime-monitor
          path: arbitrum-monitoring
          fetch-depth: 1

      - name: Cache Monitoring dependencies
        uses: actions/cache@v4
        with:
          path: arbitrum-monitoring/node_modules
          key: ${{ runner.os }}-monitoring-yarn-${{ hashFiles('arbitrum-monitoring/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-monitoring-yarn-
      - name: Install dependencies (Monitoring)
        run: cd arbitrum-monitoring && yarn install

      - name: Generate Orbit chains config
        run: cd arbitrum-portal && yarn workspace arb-token-bridge-ui generateOrbitChainsToMonitor
        env:
          NEXT_PUBLIC_INFURA_KEY: ${{ secrets.NEXT_PUBLIC_INFURA_KEY }}

      - name: Copy config to monitoring repo
        run: |
          cp arbitrum-portal/packages/arb-token-bridge-ui/public/__auto-generated-orbit-chains.json \
             arbitrum-monitoring/config.json

      - name: Run chain uptime monitor with InfluxDB
        run: |
          cd arbitrum-monitoring
          yarn chain-uptime-monitor --writeToInfluxDB
        env:
          INFLUXDB_URL: ${{ secrets.INFLUXDB_URL }}
          INFLUXDB_TOKEN: ${{ secrets.INFLUXDB_TOKEN }}
          INFLUXDB_ORG: ${{ secrets.INFLUXDB_ORG }}
          INFLUXDB_BUCKET: ${{ secrets.INFLUXDB_BUCKET }}
